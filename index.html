<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stray Clans Collective</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        :root {
            --primary-color: #3b82f6;
            --secondary-color: #6366f1;
            --bg-color: #0f172a;
            --surface-color: #1e293b;
            --border-color: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #64748b;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.5;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .title {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 20px;
        }
        
        .stats-summary {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px 24px;
            text-align: center;
            min-width: 120px;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }
        
        .clans-overview {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .sort-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .sort-btn {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .sort-btn:hover, .sort-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-color);
        }
        
        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        th {
            background: var(--surface-color);
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }
        
        td {
            color: var(--text-secondary);
        }
        
        tr:hover {
            background: rgba(59, 130, 246, 0.05);
        }
        
        .clan-name {
            color: var(--text-primary);
            font-weight: 600;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .clan-name:hover {
            color: var(--primary-color);
        }
        
        .rank-change {
            font-size: 0.8rem;
            margin-left: 4px;
        }
        
        .rank-up {
            color: var(--success-color);
        }
        
        .rank-down {
            color: var(--error-color);
        }
        
        .members-section {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
        }
        
        .clan-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 4px;
        }
        
        .clan-tab {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            font-size: 0.875rem;
        }
        
        .clan-tab.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .members-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        .search-input {
            padding: 8px 12px;
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.875rem;
            width: 200px;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }
        
        .member-rank {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .member-stat {
            font-family: monospace;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .title {
                font-size: 2rem;
            }
            
            .stats-summary {
                gap: 10px;
            }
            
            .stat-card {
                padding: 12px 16px;
                min-width: 100px;
            }
            
            .section-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }
            
            .sort-controls {
                justify-content: center;
            }
        }
        
        .numeric {
            text-align: right;
        }
        
        .lme-badge {
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .lme-d12 {
            background: #9333ea; /* Purple for D12 */
        }
        
        .lme-d11 {
            background: var(--secondary-color); /* Blue for D11 */
        }
        
        .lme-d10 {
            background: #06b6d4; /* Turquoise for D10 */
        }
        
        .lme-default {
            background: var(--text-muted); /* Default gray for other levels */
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1 class="title">Stray Clans Collective</h1>
            
            <div class="stats-summary">
                <div class="stat-card">
                    <div class="stat-value" id="totalClans">-</div>
                    <div class="stat-label">Clans</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalMembers">-</div>
                    <div class="stat-label">Members</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="lastUpdated">-</div>
                    <div class="stat-label">Updated</div>
                </div>
            </div>
        </header>

        <div class="main-content">
            <!-- Clans Overview Table -->
            <div class="clans-overview">
                <div class="section-header">
                    <h2 class="section-title">Clans Overview</h2>
                    <div class="sort-controls">
                        <button class="sort-btn active" onclick="sortClans('members')">Members</button>
                        <button class="sort-btn" onclick="sortClans('attack')">Total ATK</button>
                        <button class="sort-btn" onclick="sortClans('lme')">LME</button>
                        <button class="sort-btn" onclick="sortClans('relics')">Relics</button>
                        <button class="sort-btn" onclick="sortClans('grade')">Lunar Points</button>
                        <button class="sort-btn" onclick="sortClans('phase')">Phase 1</button>
                        <button class="sort-btn" onclick="sortClans('rank')">Rank</button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="clansTable">
                        <thead>
                            <tr>
                                <th>Clan Name</th>
                                <th>Guild ID</th>
                                <th class="numeric">Members</th>
                                <th class="numeric">Total ATK</th>
                                <th>LME</th>
                                <th class="numeric">Total Relics</th>
                                <th class="numeric">Lunar Points</th>
                                <th class="numeric">Phase 1 Score</th>
                                <th class="numeric">Global Rank</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="9" class="loading">Loading clan data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Members Section with Clan Tabs -->
            <div class="members-section">
                <div class="section-header">
                    <h2 class="section-title">Members</h2>
                    <div class="members-controls">
                        <input type="text" id="memberSearch" class="search-input" placeholder="Search members...">
                        <div class="sort-controls">
                            <button class="sort-btn active" onclick="sortMembers('attack')">Attack</button>
                            <button class="sort-btn" onclick="sortMembers('relics')">Relic Cores</button>
                        </div>
                    </div>
                </div>
                
                <div class="clan-tabs" id="clanTabs">
                    <div class="loading">Loading clans...</div>
                </div>
                
                <div class="table-container">
                    <table id="membersTable">
                        <thead>
                            <tr>
                                <th>Member Name</th>
                                <th class="numeric">Attack Rank</th>
                                <th class="numeric">Attack Power</th>
                                <th class="numeric">Relic Rank</th>
                                <th class="numeric">Relic Cores</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="5" class="loading">Select a clan to view members...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="clansData.js"></script>
    <script src="membersData.js"></script>
    <script>
        let allClans = [];
        let allMembers = [];
        let clansChangesData = {};
        let currentClan = null;
        let currentSort = { type: 'clans', field: 'members', direction: 'desc' };

        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            setupEventListeners();
        });

        function loadData() {
            try {
                // Load member data
                allMembers = typeof membersData !== 'undefined' ? [...membersData] : [];
                
                // Load clan data, or extract from members if not available
                if (typeof clansData !== 'undefined') {
                    allClans = [...clansData];
                } else {
                    // Extract unique clans from members data
                    const uniqueClans = [...new Set(allMembers.map(m => m.Clan_Name))];
                    allClans = uniqueClans.map(clanName => ({
                        Name: clanName,
                        Guild_ID: 'N/A',
                        Member_Count: 'N/A',
                        Total_Attack: 'N/A',
                        LME_Level: null,
                        Total_Relic_Cores: 'N/A',
                        Phase_Score: null,
                        Global_Rank: 'N/A'
                    }));
                }
                
                // Load changes data if available
                if (typeof clansChanges !== 'undefined') {
                    clansChangesData = clansChanges;
                    console.log('Changes data loaded:', Object.keys(clansChangesData).length, 'clans with changes');
                } else {
                    clansChangesData = {};
                }
                
                // Calculate dynamic player counts
                const currentPlayers = allMembers.length;
                const maxPlayers = allClans.length * 40; // 40 members per clan max
                
                // Update stats
                document.getElementById('totalClans').textContent = allClans.length;
                document.getElementById('totalMembers').textContent = `${currentPlayers}/${maxPlayers}`;
                
                if (typeof clansMetadata !== 'undefined') {
                    const date = new Date(clansMetadata.lastUpdated).toLocaleDateString();
                    document.getElementById('lastUpdated').textContent = date;
                } else if (typeof membersMetadata !== 'undefined') {
                    const date = new Date(membersMetadata.lastUpdated).toLocaleDateString();
                    document.getElementById('lastUpdated').textContent = date;
                }
                
                // Initialize display
                renderClansTable();
                renderClanTabs();
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.querySelector('.loading').textContent = 'Error loading data';
            }
        }

        function setupEventListeners() {
            const searchInput = document.getElementById('memberSearch');
            searchInput.addEventListener('input', debounce(filterMembers, 300));
        }

        function renderClansTable() {
            const tbody = document.querySelector('#clansTable tbody');
            
            if (allClans.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="loading">No clan data available</td></tr>';
                return;
            }

            const html = allClans.map(clan => {
                // Get changes for this clan
                const changes = getClanChanges(clan.Name);
                
                // Parse Lunar Points (Grade_Score) to extract base points and change
                let lunarPoints = 'N/A';
                if (clan.Grade_Score) {
                    const parts = clan.Grade_Score.split(' ');
                    const basePoints = parts[0];
                    const change = parts[1] || '';
                    lunarPoints = `${basePoints}${change ? ` <span class="rank-change ${change.startsWith('+') ? 'rank-up' : change.startsWith('-') ? 'rank-down' : ''}">(${change})</span>` : ''}`;
                }
                
                // Add change indicators to each metric
                const memberCountChange = formatChangeIndicator(changes.members, 'members');
                const rankChange = formatChangeIndicator(changes.rank, 'rank');
                const attackChange = formatChangeIndicator(changes.attack, 'attack');
                const relicsChange = formatChangeIndicator(changes.relics, 'relics');
                
                return `
                    <tr>
                        <td class="clan-name" onclick="selectClan('${clan.Name}')">${clan.Name}</td>
                        <td>${clan.Guild_ID}</td>
                        <td class="numeric">${clan.Member_Count || 'N/A'}${memberCountChange}</td>
                        <td class="numeric">${clan.Total_Attack}${attackChange}</td>
                        <td><span class="lme-badge ${getLMEClass(clan.LME_Level)}">D${clan.LME_Level || 'N/A'}</span></td>
                        <td class="numeric">${clan.Total_Relic_Cores}${relicsChange}</td>
                        <td class="numeric">${lunarPoints}</td>
                        <td class="numeric">${clan.Phase_Score ? clan.Phase_Score.toLocaleString() : 'N/A'}</td>
                        <td class="numeric">${clan.Global_Rank}${rankChange}</td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = html;
        }

        function renderClanTabs() {
            const tabsContainer = document.getElementById('clanTabs');
            
            if (allClans.length === 0) {
                tabsContainer.innerHTML = '<div class="loading">No clans available</div>';
                return;
            }

            // Sort clans alphabetically for better organization
            const sortedClans = [...allClans].sort((a, b) => a.Name.localeCompare(b.Name));

            const html = sortedClans.map((clan, index) => `
                <button class="clan-tab ${index === 0 ? 'active' : ''}" 
                        onclick="selectClan(\`${clan.Name}\`)" 
                        data-clan="${clan.Name}">
                    ${clan.Name}
                </button>
            `).join('');
            
            tabsContainer.innerHTML = html;
            
            // Auto-select first clan
            if (sortedClans.length > 0) {
                selectClan(sortedClans[0].Name);
            }
        }

        function selectClan(clanName) {
            currentClan = clanName;
            console.log('Selected clan:', clanName); // Debug log
            
            // Update tab appearance
            document.querySelectorAll('.clan-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.clan === clanName);
            });
            
            // Filter and display members
            renderMembersTable();
        }

        function getLMEClass(lmeLevel) {
            switch(lmeLevel) {
                case 12:
                    return 'lme-d12'; // Purple
                case 11:
                    return 'lme-d11'; // Blue  
                case 10:
                    return 'lme-d10'; // Turquoise
                default:
                    return 'lme-default'; // Gray
            }
        }

        function formatChangeIndicator(changeValue, type = 'default') {
            if (!changeValue || changeValue === 0) return '';
            
            const isPositive = changeValue > 0;
            const className = isPositive ? 'rank-up' : 'rank-down';
            const symbol = isPositive ? '+' : '';
            
            // Format different types of changes
            let displayValue = '';
            switch(type) {
                case 'rank':
                    // For rank, positive change means rank improved (went down in number)
                    displayValue = `${symbol}${changeValue}`;
                    break;
                case 'attack':
                    displayValue = `${symbol}${changeValue.toFixed(1)}M`;
                    break;
                case 'members':
                case 'relics':
                case 'lunar':
                default:
                    displayValue = `${symbol}${changeValue}`;
                    break;
            }
            
            return ` <span class="rank-change ${className}">(${displayValue})</span>`;
        }

        function getClanChanges(clanName) {
            return clansChangesData[clanName] || {};
        }

        function normalizeClanName(name) {
            // Normalize clan names to handle character encoding differences
            // BUT preserve important distinctions like dots in names
            return name.toUpperCase()
                      .replace(/[ˢᵗʳᵃʸ]/g, 'STRAY')
                      .replace(/[⚚]/g, '')
                      .replace(/[\s\-]/g, '')
                      // DON'T remove dots - they're significant (ChaoticAF vs ChaoticAF.)
                      .trim();
        }

        function findMatchingClanName(targetClan, membersList) {
            // First try exact match
            const exactMatch = membersList.find(m => m.Clan_Name === targetClan);
            if (exactMatch) return targetClan;
            
            // Then try normalized matching
            const normalizedTarget = normalizeClanName(targetClan);
            const matchingMember = membersList.find(m => 
                normalizeClanName(m.Clan_Name) === normalizedTarget
            );
            
            return matchingMember ? matchingMember.Clan_Name : targetClan;
        }

        function renderMembersTable() {
            const tbody = document.querySelector('#membersTable tbody');
            
            if (!currentClan) {
                tbody.innerHTML = '<tr><td colspan="5" class="loading">Select a clan to view members</td></tr>';
                return;
            }

            // Find the correct clan name in members data
            const matchingClanName = findMatchingClanName(currentClan, allMembers);
            let clanMembers = allMembers.filter(member => member.Clan_Name === matchingClanName);
            
            // Don't auto-sort here - let user choose sorting via buttons
            // Default to attack position sorting only when clan is first loaded
            if (!clanMembers.some(m => m._sorted)) {
                clanMembers.sort((a, b) => {
                    const posA = parseInt(a.Attack_Position) || 999;
                    const posB = parseInt(b.Attack_Position) || 999;
                    return posA - posB;
                });
                // Mark as having default sort
                clanMembers.forEach(m => m._sorted = true);
            }
            
            console.log('Looking for clan:', currentClan);
            console.log('Found matching name:', matchingClanName);
            console.log('Found members:', clanMembers.length);
            
            if (clanMembers.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="5" class="loading">
                        No members found for ${currentClan}<br>
                        <small style="color: var(--text-muted);">Available clans in member data: ${[...new Set(allMembers.map(m => m.Clan_Name))].join(', ')}</small>
                    </td></tr>`;
                return;
            }

            const html = clanMembers.map(member => `
                <tr>
                    <td>${member.Member_Name}</td>
                    <td class="numeric member-rank">#${member.Attack_Position}</td>
                    <td class="numeric member-stat">${member.Attack}</td>
                    <td class="numeric member-rank">#${member.Relic_Position}</td>
                    <td class="numeric member-stat">${member.Relic_Cores}</td>
                </tr>
            `).join('');
            
            tbody.innerHTML = html;
        }

        function sortClans(field) {
            // Update button appearance
            document.querySelectorAll('.clans-overview .sort-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Toggle direction if same field, but set default direction based on field
            if (currentSort.type === 'clans' && currentSort.field === field) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                // For rank, default to ascending (lower numbers first)
                // For others, default to descending (higher numbers first)
                currentSort = { 
                    type: 'clans', 
                    field: field, 
                    direction: field === 'rank' ? 'asc' : 'desc' 
                };
            }

            allClans.sort((a, b) => {
                let valueA, valueB;
                
                switch(field) {
                    case 'members':
                        valueA = parseInt(a.Member_Count?.split('/')[0]) || 0;
                        valueB = parseInt(b.Member_Count?.split('/')[0]) || 0;
                        break;
                    case 'attack':
                        valueA = parseFloat(a.Total_Attack.replace(/[^\d.]/g, '')) || 0;
                        valueB = parseFloat(b.Total_Attack.replace(/[^\d.]/g, '')) || 0;
                        break;
                    case 'lme':
                        valueA = a.LME_Level || 0;
                        valueB = b.LME_Level || 0;
                        break;
                    case 'relics':
                        valueA = parseInt(a.Total_Relic_Cores?.replace(/\+/g, '')) || 0;
                        valueB = parseInt(b.Total_Relic_Cores?.replace(/\+/g, '')) || 0;
                        break;
                    case 'grade':
                        // Extract numeric value from Grade_Score (e.g., "1180 +30" -> 1180)
                        valueA = parseInt((a.Grade_Score || '0').split(' ')[0]) || 0;
                        valueB = parseInt((b.Grade_Score || '0').split(' ')[0]) || 0;
                        break;
                    case 'phase':
                        valueA = a.Phase_Score || 0;
                        valueB = b.Phase_Score || 0;
                        break;
                    case 'rank':
                        valueA = parseInt(a.Global_Rank) || 999999;
                        valueB = parseInt(b.Global_Rank) || 999999;
                        break;
                    default:
                        return 0;
                }
                
                return currentSort.direction === 'asc' ? valueA - valueB : valueB - valueA;
            });

            renderClansTable();
        }

        function sortMembers(field) {
            // Update button appearance
            document.querySelectorAll('.members-section .sort-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if (!currentClan) return;

            // Find the correct clan name in members data
            const matchingClanName = findMatchingClanName(currentClan, allMembers);
            let clanMembers = allMembers.filter(member => member.Clan_Name === matchingClanName);
            
            clanMembers.sort((a, b) => {
                let posA, posB;
                
                switch(field) {
                    case 'attack':
                        posA = parseInt(a.Attack_Position) || 999;
                        posB = parseInt(b.Attack_Position) || 999;
                        break;
                    case 'relics':
                        posA = parseInt(a.Relic_Position) || 999;
                        posB = parseInt(b.Relic_Position) || 999;
                        break;
                    default:
                        return 0;
                }
                
                return posA - posB; // Sort by position (rank) - lower numbers first
            });

            // Update the global members array for this clan
            allMembers = allMembers.filter(member => member.Clan_Name !== matchingClanName).concat(clanMembers);
            
            renderMembersTable();
        }

        function filterMembers() {
            const searchTerm = document.getElementById('memberSearch').value.toLowerCase();
            
            if (!currentClan) return;

            // Find the correct clan name in members data
            const matchingClanName = findMatchingClanName(currentClan, allMembers);
            let clanMembers = allMembers.filter(member => member.Clan_Name === matchingClanName);
            
            if (searchTerm) {
                clanMembers = clanMembers.filter(member => 
                    member.Member_Name.toLowerCase().includes(searchTerm)
                );
            }

            // Render filtered results
            const tbody = document.querySelector('#membersTable tbody');
            
            if (clanMembers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="loading">No members found</td></tr>';
                return;
            }

            const html = clanMembers.map(member => `
                <tr>
                    <td>${member.Member_Name}</td>
                    <td class="numeric member-rank">#${member.Attack_Position}</td>
                    <td class="numeric member-stat">${member.Attack}</td>
                    <td class="numeric member-rank">#${member.Relic_Position}</td>
                    <td class="numeric member-stat">${member.Relic_Cores}</td>
                </tr>
            `).join('');
            
            tbody.innerHTML = html;
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
</body>
</html>
